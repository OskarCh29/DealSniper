<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set Your Password</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f2f2f2; margin:0; padding:0; }
        .container { max-width: 400px; margin: 60px auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; font-size: 16px; }
        button { width: 100%; padding: 12px; margin-top: 15px; border: none; border-radius: 5px; background-color: #007BFF; color: #fff; font-size: 16px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        .error { color: red; font-size: 14px; margin-top: 5px; }
        .success { color: green; font-size: 14px; margin-top: 5px; }
        .password-requirements { text-align: left; font-size: 14px; margin-top: 10px; }
        .password-requirements li { color: red; margin: 4px 0; }
        .password-requirements li.valid { color: green; }
        .password-container { position: relative; }
        .toggle-visibility { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; width: 24px; height: 24px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Set Your Password</h2>
    <form id="passwordForm">
        <input type="hidden" name="code" id="codeInput">

        <div class="password-container">
            <input type="password" name="password" id="password" placeholder="Enter password" required>
            <span class="toggle-visibility" id="togglePassword"><span class="eye"></span></span>
        </div>

        <div class="password-container">
            <input type="password" name="confirmPassword" id="confirmPassword" placeholder="Confirm password" required>
            <span class="toggle-visibility" id="toggleConfirmPassword"><span class="eye"></span></span>
        </div>

        <ul class="password-requirements" id="passwordRequirements">
            <li id="length">At least 8 characters</li>
            <li id="uppercase">At least 1 uppercase letter</li>
            <li id="number">At least 1 number</li>
            <li id="special">At least 1 special character (!@#$%^&*)</li>
        </ul>

        <button type="submit">Complete Registration</button>
        <div class="error" id="errorMsg"></div>
        <div class="success" id="successMsg"></div>
    </form>
</div>

<script>
    // Pobranie kodu z URL
    const urlParams = new URLSearchParams(window.location.search);
    const verificationCode = urlParams.get('code');
    document.getElementById('codeInput').value = verificationCode;

    const form = document.getElementById('passwordForm');
    const passwordInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    const errorMsg = document.getElementById('errorMsg');
    const successMsg = document.getElementById('successMsg');

    // Toggle visibility function
    function toggleVisibility(input, toggle) {
        toggle.addEventListener('click', () => {
            if (input.type === 'password') {
                input.type = 'text';
                toggle.querySelector('.eye').classList.add('hidden');
            } else {
                input.type = 'password';
                toggle.querySelector('.eye').classList.remove('hidden');
            }
        });
    }

    toggleVisibility(passwordInput, document.getElementById('togglePassword'));
    toggleVisibility(confirmInput, document.getElementById('toggleConfirmPassword'));

    // Walidacja w czasie rzeczywistym
    const requirements = {
        length: pwd => pwd.length >= 8,
        uppercase: pwd => /[A-Z]/.test(pwd),
        number: pwd => /[0-9]/.test(pwd),
        special: pwd => /[!@#$%^&*]/.test(pwd)
    };

    passwordInput.addEventListener('input', () => {
        const pwd = passwordInput.value;
        for (const key in requirements) {
            const el = document.getElementById(key);
            if (requirements[key](pwd)) el.classList.add('valid');
            else el.classList.remove('valid');
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        errorMsg.textContent = '';
        successMsg.textContent = '';

        const password = passwordInput.value;
        const confirmPassword = confirmInput.value;
        const code = document.getElementById('codeInput').value;

        // Sprawdzenie wymagaÅ„
        for (const key in requirements) {
            if (!requirements[key](password)) {
                errorMsg.textContent = "Password does not meet all requirements!";
                return;
            }
        }

        if (password !== confirmPassword) {
            errorMsg.textContent = "Passwords do not match!";
            return;
        }

        try {
            const response = await fetch('http://localhost:8080/api/v1/users/verification/complete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ code, password })
            });

            if (response.ok) {
                successMsg.textContent = "Account verified successfully!";
                setTimeout(() => window.location.href = "/login", 1500);
            } else {
                const data = await response.json();
                errorMsg.textContent = data.message || "Verification failed!";
            }
        } catch (err) {
            console.error(err);
            errorMsg.textContent = "An error occurred. Try again later.";
        }
    });
</script>
</body>
</html>
